name: build-debs

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro:
          - { name: debian, suite: bookworm, image: "debian:bookworm" }
          - { name: debian, suite: trixie,   image: "debian:trixie" }
          - { name: ubuntu, suite: "22.04",  image: "ubuntu:22.04" }
          - { name: ubuntu, suite: "24.04",  image: "ubuntu:24.04" }
        arch:
          - { name: amd64, platform: "linux/amd64" }
          - { name: i386,  platform: "linux/386" }
          - { name: arm64, platform: "linux/arm64" }
          - { name: armhf, platform: "linux/arm/v7" }
        exclude:
          - distro: { name: ubuntu, suite: "22.04", image: "ubuntu:22.04" }
            arch:   { name: i386, platform: "linux/386" }
          - distro: { name: ubuntu, suite: "24.04", image: "ubuntu:24.04" }
            arch:   { name: i386, platform: "linux/386" }
        include:
          - distro: { name: rpios, suite: bookworm, image: "balenalib/rpi-raspbian:bookworm" }
            arch:   { name: armv6, platform: "linux/arm/v6" }

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - uses: docker/setup-buildx-action@v3

      - name: Build .deb in target container
        env:
          IMAGE: ${{ matrix.distro.image }}
          PLATFORM: ${{ matrix.arch.platform }}
        run: |
          set -euxo pipefail

          docker run --rm -t \
            --platform "${PLATFORM}" \
            -v "$PWD:/src" -w /src \
            "${IMAGE}" bash -lc '
              set -euxo pipefail
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              apt-get install -y --no-install-recommends \
                ca-certificates \
                build-essential \
                devscripts \
                equivs \
                debhelper \
                dpkg-dev \
                fakeroot \
                cmake \
                pkg-config \
                ninja-build \
                libusb-1.0-0-dev

              # Install Build-Depends from debian/control (robust across distros/arches)
              mk-build-deps -i -t "apt-get -y --no-install-recommends" -r debian/control
              rm -f ./*build-deps*.deb || true

              dpkg-buildpackage -us -uc -b

              mkdir -p /src/out
              cp -v ../*.deb ../*.buildinfo ../*.changes /src/out/ || true
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debs-${{ matrix.distro.name }}-${{ matrix.distro.suite }}-${{ matrix.arch.name }}
          path: out/

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect release files
        id: collect
        run: |
          set -euo pipefail
          find dist -type f \( -name '*.deb' -o -name '*.buildinfo' -o -name '*.changes' \) -print > /tmp/release-files.txt
          if [ ! -s /tmp/release-files.txt ]; then
            echo "No artifacts found in dist/"; exit 1;
          fi
          echo "files<<'EOF'" >> "$GITHUB_OUTPUT"
          cat /tmp/release-files.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create/Update GitHub Release and upload packages
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.collect.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
