name: build-debs

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro:
          - { name: debian, suite: bookworm }
          - { name: debian, suite: trixie }
          - { name: ubuntu, suite: "22.04" }
          - { name: ubuntu, suite: "24.04" }
        arch: [amd64, i386, arm64, armhf]

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - uses: docker/setup-buildx-action@v3

      - name: Build .deb in target container
        env:
          DISTRO: ${{ matrix.distro.name }}
          SUITE: ${{ matrix.distro.suite }}
          ARCH: ${{ matrix.arch }}
        run: |
          set -euxo pipefail

          if [ "$DISTRO" = "debian" ]; then
            IMAGE="${ARCH}/debian:${SUITE}"
          else
            IMAGE="${ARCH}/ubuntu:${SUITE}"
          fi

          docker run --rm -t \
            --platform "linux/${ARCH}" \
            -v "$PWD:/src" -w /src \
            "$IMAGE" bash -lc '
              set -euxo pipefail
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              apt-get install -y --no-install-recommends \
                build-essential devscripts debhelper dpkg-dev fakeroot \
                ca-certificates cmake pkg-config \
                ninja-build

              dpkg-buildpackage -us -uc -b

              mkdir -p /src/out
              cp -v ../*.deb ../*.buildinfo ../*.changes /src/out/ || true
            '

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debs-${{ matrix.distro.name }}-${{ matrix.distro.suite }}-${{ matrix.arch }}
          path: out/

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create/Update GitHub Release and upload packages
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*.deb
            dist/**/*.buildinfo
            dist/**/*.changes
